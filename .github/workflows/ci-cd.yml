name: My Workflow
on:
    push:
        branches: [ main ]
jobs:
    test:
        name: Run tests
        runs-on: ubuntu-latest
        steps:
          - name: Get code
            uses: actions/checkout@v4

          - name: Set up python
            uses: actions/setup-python@v4
            with: 
                python-version: '3.11'

          - name: Install packages
            run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

          - name: Run tests
            run: pytest tests/test_everything.py -v

          - name: Test local
            run: |
                python main.py & sleep 5
                curl http://localhost:8000/health
                pkill -f "python main.py"

          - name: Success message
            run: echo "Tests completed successfully!"
    
    build:
        name: Build docker image
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Check out code
              run: actions/checkout@v4

            - name: Build docker image
              run: docker build -t calculator-api:${{ github.sha }} .

            - name: Test docker image
              run: |
                docker run -d -p 8000:8000 --name test-calculator calculator-api:${{ github.sha }}
                sleep 10
                curl http://loclahost:8000/health
                docker stop test-container
                docker rm test-container

            - name: Build success
              run: echo "üê≥ Docker build completed successfully!"